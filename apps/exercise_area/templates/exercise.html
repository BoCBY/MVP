{% extends "navbar.html" %}
{% load static %}

{% block exercise_active %}
active
{% endblock exercise_active %}

{% block exercise_active_span %}
<span class="sr-only">(current)</span>
{% endblock exercise_active_span %}
<!-- 上面這些完善導航條的外觀顯示 -->

  {% block css %}

  <link rel="stylesheet" href="{% static 'css/exercise_style.css' %}">

  {% endblock css %}



{% block content %}

<div class='area-container'>
  <div style='margin-top:0.5rem;'>
    <div class='search-container d-flex justify-content-end'>
      <a href='#'><i id='subjectSearchIcon' class="fa-solid fa-magnifying-glass search-icon" style='margin-left:0.6rem; transform: translateY(-45%);'></i></a>
      <input id='subjectSearchInput' class='search-input' type='text' placeholder='搜尋' style='display:none; margin-left:5px;'>
    </div>
    <div id="allSubjectContainer"> 
      <!-- 後台中, exercise裡面, 各科目的資料夾名稱要與這邊各button的subject屬性一樣 -->
      <!-- 一個大主科就給他一個div去存放 -->
      <!-- 大主科裡面的每一個科目就給他一顆button -->
      <!-- 這裡的大科目要放置的button就1~2顆有代表性的即可, 在這裡不一定每次新建小科目都要新增按鈕 -->
      <div id="math" class="subject-container">
        <h5 class='header-style'>數學</h5>
        <div class='container'>
          <button id="calculusBtn" subject='calculus' type="button" class="btn btn-outline-secondary subject-btn" style='padding: 0.1rem 0.2rem; margin-left:1.5rem;'>微積分</button>
          <button id="linAlgeBtn" subject='linear_algebra' type="button" class="btn btn-outline-secondary subject-btn" style='padding: 0.1rem 0.2rem;'>線性代數</button> 
          <button id="mathMore" type="button" class="btn btn-outline-dark show-more" style='padding: 0.1rem 0.2rem;'><i class="fa-solid fa-ellipsis"></i></button>
        </div>
      </div>
      <div id="physics" class="subject-container">
        <h5 class='header-style'>物理</h5>
        <div class='container'>
          <button id="GenPhyBtn" subject='general_physics' type="button" class="btn btn-outline-secondary subject-btn" style='padding: 0.1rem 0.2rem; margin-left:1.5rem;'>普通物理</button>
          <button id="physicsMore" type="button" class="btn btn-outline-dark show-more" style='padding: 0.1rem 0.2rem;'><i class="fa-solid fa-ellipsis"></i></button>
        </div>
      </div>
      <div id="computerScience" class="subject-container">
        <h5 class='header-style'>資訊科學</h5>
        <div class='container'>
          <button id="dataStructureBtn" subject='data_structure' type="button" class="btn btn-outline-secondary subject-btn" style='padding: 0.1rem 0.2rem; margin-left:1.5rem;'>資料結構</button> 
          <button id="computerScienceMore" type="button" class="btn btn-outline-dark show-more" style='padding: 0.1rem 0.2rem;'><i class="fa-solid fa-ellipsis"></i></button>
        </div>
      </div>
    </div>
  </div>
</div>
  
<!-- 放置各科目button的modal -->
<div class="modal fade" id="showMoreModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title" id="showMoreModalLabel"><strong id='showMoreModalTitle'>Modal title</strong></h6>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div id= 'showMoreTopContainer' class='container'>
            <div class='search-container d-flex justify-content-end'>
              <a href='#'><i id='showMoreSearchIcon' class="fa-solid fa-magnifying-glass search-icon" style='transform: translateY(-45%);'></i></a>
              <input id='showMoreSearchInput' class='search-input' type='text' placeholder='搜尋' style='display:none; margin-left:5px;'>
            </div>
        </div>
        <div id='subjectBtnContainer' class='container' style='margin-top:0.3rem;'>
          
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 各科目的modal -->
<div class="modal fade" id="exerciseModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title" id="exerciseModalLabel"><strong id='exerciseModalTitle'></strong></h6>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class='container-fluid'>
          <div id='exerciseTopContainer' class='d-flex'>
            <a href='#' id='exerciseModalPrevious' class='previous'><i class="fa-solid fa-arrow-left"></i></a>
            <div class='ml-auto'>
              <button id="oneBtn" type="button" class="btn btn-sm btn-warning">試題</button>
            </div>
          </div>
          <div id='questions-container'>
            <div period='present'>
              <h6><strong>當期試題</strong></h6>
            </div>
            <div period='past'>
              <h6 style='margin-top:0.3rem;'><strong>歷期試題</strong></h6> 
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- 答案區的modal -->
<div class="modal fade" id="answerModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title" id="answerModalLabel"><strong id='answerModalTitle'>Modal title</strong></h6>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div id= 'ansTopContainer' style='margin-bottom:0.2rem;'>
          <a href='#' id='answerPrevious' class='previous'><i class="fa-solid fa-arrow-left"></i></a>
        </div>
        <h6><strong>題號</strong></h6>
        <table id='questionNumTable'>
          <tr>
              <td><a href='#' class='question-number'>1</a></td>
              <td><a href='#' class='question-number'>2</a></td>
              <td><a href='#' class='question-number'>3</a></td>
              <td><a href='#' class='question-number'>4</a></td>
          </tr>
          <tr>
              <td><a href='#' class='question-number'>5</a></td>
              <td><a href='#' class='question-number'>6</a></td>
              <td><a href='#' class='question-number'>7</a></td>
              <td><a href='#' class='question-number'>8</a></td>
          </tr>
          <tr>
              <td><a href='#' class='question-number'>9</a></td>
              <td><a href='#' class='question-number'>10</a></td>
              <td><a href='#' class='question-number'>11</a></td>
              <td><a href='#' class='question-number'>12</a></td>
          </tr>
      </table>
      </div>
    </div>
  </div>
</div>

<!-- 個別題號的modal -->
<div class="modal fade" id="questionNumModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title" id="ansQuestionNumModalLabel"><strong id='ansQuestionNumModalTitle'>Modal title</strong></h6>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div id= 'queNumTopContainer' class='container'>
          <div class='d-flex align-items-center'>
            <div id='prevPageContainer' class='mr-auto'>
              <a href='#' id='questionNumberPrevious' class='previous'><i class="fa-solid fa-arrow-left"></i></a>
            </div>
            <div class='search-container'>
              <a href='#'><i id='ansSearchIcon' class="fa-solid fa-magnifying-glass search-icon"></i></a>
              <input id='ansSearchInput' class='search-input' type='text' placeholder='搜尋' style='display:none;'>
            </div>
            <div id='uploadContainer' style='margin-top:12px;'>
              <label for="fileInput" id="uploadIcon">
                <a href='#'><i class="fa-solid fa-file-arrow-up upload" style="color:#888;"></i></a>
              </label>
              <input type="file" id="fileInput" accept=".txt" style="display: none"> <!-- 測試時只先接受.txt檔, 正式的話就只接受筆記板的那個檔 -->
            </div>
            <div id='sortContainer'>
              <a href='#'><i id='sortIcon' class="fa-solid fa-sort sort" style="color:#888;"></i></a>
              <div id='sortDropdown' class='dropdown-content'>
                  <a href='#' id='sortLike'>評  價</a>
                  <a href='#' id='sortDate'>上傳時間</a>
              </div>
            </div>

          </div>
        </div>
        <div id='displayFileContainer' class='container' style='margin-top:0.3rem;'>
          
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock content %}

{% block js %}
<script>
  var MAIN = undefined;
  var MAINTITLE = undefined;
  var SUBJECT = undefined;
  var DATE = undefined; // 跟著modal title日期的全域變數, regularQuestion函數的date局域變數與此無關
  var NUMBER = undefined;
  var PERIOD = undefined; // regularQuestion函數的period局域變數與此無關
  
  $(function(){
    showMore();
    subjectBtn();
    oneBtn();
    regularQuestion();
    regularAnswer();
    answerArea();
    ansQuestionNum();
    prevPage();
    upLoad();
    searchModule.init('subjectSearchIcon', 'subjectSearchInput', '#allSubjectContainer h5'); // 整頁的大科目搜尋
    searchModule.init('showMoreSearchIcon', 'showMoreSearchInput', '#subjectBtnContainer button'); // 搜尋大科目裡面的小科目
    searchModule.init('ansSearchIcon', 'ansSearchInput', '#displayFileContainer a'); // 題號區的答案搜尋
    likeDislike();
    sort();
  })

function showMore(){
  $('.show-more').click(function(){
    let $this = $(this);
    MAIN = $this.closest('.subject-container').attr('id')
    MAINTITLE = $this.closest('.subject-container').find('h5.header-style').text();
    //console.log(MAIN);
    $('#subjectBtnContainer').empty();
    
    $('#showMoreModalTitle').text(MAINTITLE);
    
    /* 這裡以上的程式碼都不用動, 接著的遵循以下指令:
    用if-else區隔大科目(如: 數學一個區塊, 物理一個區塊, 化學一個區塊, 經濟學一個區塊, ...), 如果題池有增加科目的話, 就來這邊, 依照其所屬的科目歸類, 並在那個區塊把按鈕加上去; 若要新增的科目需要創建一個主科目區塊, 就先創造該區塊再在那個區塊中建立按鈕. */
    
    if ($this.attr('id').includes('math')){ 
      // 顯示數學的科目按鈕
      let calculusBtn = $('<button>').attr({'id':'calculusBtn', 'subject':'calculus', 'type':'button', 'class':'btn btn-outline-secondary subject-btn', 'style':'padding: 0.1rem 0.2rem; margin: 0.2rem;'}).text('微積分');
      let linAlgeBtn = $('<button>').attr({'id':'linAlgeBtn', 'subject':'linear_algebra', 'type':'button', 'class':'btn btn-outline-secondary subject-btn', 'style':'padding: 0.1rem 0.2rem; margin: 0.2rem;'}).text('線性代數');
      // <button id="calculusBtn" subject='calculus' type="button" class="btn btn-outline-secondary subject-btn" style='padding: 0.1rem 0.2rem;'>微積分</button>
      // <button id="linAlgeBtn" subject='linear_algebra' type="button" class="btn btn-outline-secondary subject-btn" style='padding: 0.1rem 0.2rem;'>線性代數</button>
      $('#subjectBtnContainer').append(calculusBtn);
      $('#subjectBtnContainer').append(linAlgeBtn);
    }else if($this.attr('id').includes('physics')){
      // 顯示物理的科目按鈕
      let GenPhyBtn = $('<button>').attr({'id':'GenPhyBtn', 'subject':'general_physics', 'type':'button', 'class':'btn btn-outline-secondary subject-btn', 'style':'padding: 0.1rem 0.2rem;'}).text('普通物理');
      // <button id="GenPhyBtn" subject='general_physics' type="button" class="btn btn-outline-secondary subject-btn" style='padding: 0.1rem 0.2rem;'>普通物理</button>
      $('#subjectBtnContainer').append(GenPhyBtn);
    }else if($this.attr('id').includes('computerScience')){
      let dataStructureBtn = $('<button>').attr({'id':'dataStructureBtn', 'subject':'data_structure', 'type':'button', 'class':'btn btn-outline-secondary subject-btn', 'style':'padding: 0.1rem 0.2rem; margin: 0.2rem;'}).text('資料結構');
      // <button id="dataStructureBtn" subject='data_structure' type="button" class="btn btn-outline-secondary subject-btn" style='padding: 0.1rem 0.2rem; margin-left:1.5rem;'>資料結構</button> 
      $('#subjectBtnContainer').append(dataStructureBtn);
    }
    //else if($this.attr('id').includes('chemistry')) {如果這樣就是化學區塊 -> 製造化學的button, 如同數學與物理的作法}
     //else if($this.attr('id').includes('economics')) {如果這樣就是經濟區塊 -> 製造經濟的button, 如同數學與物理的作法}

    $('#showMoreModal').modal('show');
  });
}

function subjectBtn(){ 
    $('#subjectBtnContainer, .subject-container').on('click', '.subject-btn', function(){
      $('#showMoreModal').modal('hide');
      SUBJECT = $(this).attr('subject');
      let title = $(this).text();
      let mainTitle = $(this).closest('.subject-container').find('h5.header-style').text();
      let outsideBtnModalTitle = mainTitle + ' - ' + title;
      let insideBtnModalTitle = MAINTITLE + ' - ' + title;
      if ($(this).closest('.subject-container').length) { // outside button
        $('#exerciseModalTitle').text(outsideBtnModalTitle);
        $('#exerciseModalPrevious').hide();
        MAIN = $(this).closest('.subject-container').attr('id');
        //console.log(MAIN);
      }else if($(this).closest('#subjectBtnContainer').length) { // inside button
        $('#exerciseModalTitle').text(insideBtnModalTitle);
        $('#exerciseModalPrevious').show();
      }
      $.ajax({
        url: '/exercise/',
        type: 'post',
        data: {
          'purpose': 'makeTags',
          'subject': SUBJECT
        },
        dataType: 'JSON',
        success : function(res){
          if (res.status){
            // 先刪除已存的, 不然重複開啟按鈕會不斷生成標籤
            $('div[period="present"] .row').remove();
            $('div[period="past"] .row').remove();

            // 創建當期試題(present)的標籤
            let divRow = $('<div>').attr('class', 'row');
            let divQueCol = $('<div>').attr('class', 'col-sm-5');
            let divAnsCol = $('<div>').attr('class', 'col-sm-5');
            let pdfIcon = $('<i>').attr('class', 'fa-regular fa-file-pdf');
            let folderIcon = $('<i>').attr('class', 'fa-regular fa-folder');
            let aQuestion = $('<a>').attr({'href':'#', 'class':'regular-question', 'date': res.present}).text(res.present+'.pdf');
            let aAnswer = $('<a>').attr({'href':'#', 'class':'regular-answer', 'date': res.present}).text('答案區');
            divQueCol.append(pdfIcon);
            divQueCol.append(aQuestion);
            divAnsCol.append(folderIcon);
            divAnsCol.append(aAnswer);
            divRow.append(divQueCol);
            divRow.append(divAnsCol);
            $('div[period="present"] h6').after(divRow);

            // 創建歷期試題(past)的標籤
            $.each(res.past, function(index, date){
              let divRow = $('<div>').attr('class', 'row');
                let divQueCol = $('<div>').attr('class', 'col-sm-5');
                let divAnsCol = $('<div>').attr('class', 'col-sm-5');
                let pdfIcon = $('<i>').attr('class', 'fa-regular fa-file-pdf');
                let folderIcon = $('<i>').attr('class', 'fa-regular fa-folder');
                let aQuestion = $('<a>').attr({'href':'#', 'class':'regular-question', 'date': date}).text(date+'.pdf');
                let aAnswer = $('<a>').attr({'href':'#', 'class':'regular-answer', 'date': date}).text('答案區');
                divQueCol.append(pdfIcon);
                divQueCol.append(aQuestion);
                divAnsCol.append(folderIcon);
                divAnsCol.append(aAnswer);
                divRow.append(divQueCol);
                divRow.append(divAnsCol);
                $('div[period="past"] h6').after(divRow);
            });
            
            $('#exerciseModal').modal('show');
          }else{
            alert(res.error);
          }
        }
      });
    });
}

function oneBtn(){
    $('#oneBtn').click(function(){
      $.ajax({
        url:'/exercise/',
        type:'post',
        data:{ 
          'purpose': 'oneBtn',
          'SUBJECT': SUBJECT,
        },
        success: function(res){
          if(res.status){
            window.location.href = '/serve_pdf/?path=' + encodeURIComponent(res.pdf_path);
          }else {
            alert(res.error)
          }
        }
      });
    });
}

function regularQuestion(){
    $('#questions-container').on('click', '.regular-question', function(){
      let date = $(this).attr('date');
      let fileName = $(this).text();
      let period = $(this).closest('[period]').attr('period');
      // console.log(period)

    $.ajax({
      url:'/exercise/',
      type:'post',
      data:{
        'purpose': 'regularQuestion',
        'subject': SUBJECT,
        'date': date,
        'fileName': fileName,
        'period': period,
      },
      success: function(res){
        if (res.status){
          let newTab = window.open('/serve_pdf/?path=' + encodeURIComponent(res.file_path), '_blank');
          /*setTimeout(function(){
            newTab.document.title = fileName;
          }, 2000);*/
        }else{
          alert(res.error)
        }
      }
    })
  })
}

function regularAnswer(){
  $('#displayFileContainer').on('click', '.answer-file', function(){
    let fileName = $(this).text();

    $.ajax({
      url:'/exercise/',
      type:'post',
      data:{
        'purpose': 'regularAnswer',
        'subject': SUBJECT,
        'date': DATE,
        'number': NUMBER,
        'period': PERIOD,
        'fileName': fileName,
      },
      success: function(res){
        if (res.status){
          let newTab = window.open('/download_answer_panel/?path=' + encodeURIComponent(res.file_path), '_blank');
          setTimeout(function() {// 為新開頁面設置title
            newTab.document.title = fileName;
        }, 100);
        }else{
          alert(res.error)
        }
      }
    });
  });
}
        
function answerArea(){
  $('#questions-container').on('click', '.regular-answer', function(){
    DATE = $(this).attr('date');
    PERIOD = $(this).closest('[period]').attr('period');
    let prevModalTitle = $('#exerciseModalTitle').text()
    $('#answerModalTitle').text(prevModalTitle +' - '+ DATE);
    $('#answerModal').modal('show');
    $('#exerciseModal').modal('hide');
  })
}

function ansQuestionNum(){
  $('#questionNumTable').on('click', '.question-number', function(){
    NUMBER = $(this).text()
    let prevModalTitle = $('#answerModalTitle').text()
    $('#ansQuestionNumModalTitle').text(prevModalTitle + ' - ' + NUMBER)
    $('#answerModal').modal('hide');

    $.ajax({
      url:'/exercise/',
      type:'post',
      data:{
        'purpose':'openQuestionNumModal',
        'number': NUMBER,
        'date': DATE,
        'period': PERIOD,
        'subject': SUBJECT,
      },
      dataType:'JSON',
      success: function(res){
        if(res.status){
          /* 創建該題號資料夾裡的DOM標籤 */

          // 先把原本已有的刪除
          $('#displayFileContainer').empty();

          // 開始建DOM標籤
          $.each(res.file_dict, function(fileName, likeDislikeData){
            let divRow = $('<div>').attr('class', 'row');
            let divGrid = $('<div>').attr('class', 'col-sm-12 d-flex align-items-center');
            let notePanelIcon = $('<i>').attr('class', 'fa-solid fa-pen-to-square');
            let saveToNoteIcon =$('<i>').attr({'class':'fa-solid fa-share mr-auto save-to-note','style':'margin-left:0.5rem;'});
            let likeIcon = $('<i>').attr('class', 'fa-regular fa-thumbs-up like-btn');
            let dislikeIcon = $('<i>').attr('class', 'fa-regular fa-thumbs-down dislike-btn');
            // a與span標籤中喜歡數與不喜歡數是儲存在資料本身的, 要到後台獲取然後填上去
            let spanLike = $('<span>').attr('class', 'like-count').text(likeDislikeData.like); // 對應a的data-like
            let spanDislike = $('<span>').attr('class', 'dislike-count').text(likeDislikeData.dislike); // 對應a的data-dislike
            let a = $('<a>').attr({'href': '#', 'class': 'answer-file', 'data-like': likeDislikeData.like, 'data-dislike': likeDislikeData.dislike,}).text(fileName);
            divGrid.append(notePanelIcon);
            divGrid.append(a);
            divGrid.append(saveToNoteIcon);
            divGrid.append(likeIcon);
            divGrid.append(spanLike);
            divGrid.append(dislikeIcon);
            divGrid.append(spanDislike);
            divRow.append(divGrid);
            $('#displayFileContainer').append(divRow);
          })
          likeDislikeCount();
          $('#questionNumModal').modal('show');
        }else{
          alert(res.error)
        }
      }
    })
  })
}

function prevPage(){
  $('#exerciseTopContainer').on('click', '#exerciseModalPrevious', function(){
    $('#exerciseModal').modal('hide');
    $('#showMoreModal').modal('show');
  });

  $('#queNumTopContainer').on('click', '#questionNumberPrevious', function(){
    $('#questionNumModal').modal('hide');
    $('#answerModal').modal('show');
  });

  $('#ansTopContainer').on('click', '#answerPrevious', function(){
    $('#answerModal').modal('hide');
    $('#exerciseModal').modal('show');
  });
}

function upLoad(){
  // 點擊圖標就能上傳檔案的功能
  $('#uploadIcon').on('click', function() {
    $('#fileInput').click();
  });
  
  $('#fileInput').on('change', function() {
    const file = this.files[0];
    if (file.type === 'text/plain') {
      uploadFile(file);
    } else {
      alert('Please select a .txt file');
    }
  });
}

function uploadFile(file) {
  const formData = new FormData(); // a built-in class in js which is key-value pair inside for coveniently using when uploading file
  formData.append('file', file);
  formData.append('subject', SUBJECT);
  formData.append('number', NUMBER);
  formData.append('date', DATE);
  formData.append('period', PERIOD);

  $.ajax({
    url: '/upload_file/', 
    type: 'POST',
    data: formData,
    processData: false,
    contentType: false,
    success: function(res) {
      if(res.status){
        alert(res.message);
        let divRow = $('<div>').attr('class', 'row');
        let divGrid = $('<div>').attr('class', 'col-sm-12 d-flex align-items-center');
        let notePanelIcon = $('<i>').attr('class', 'fa-solid fa-pen-to-square');
        let saveToNoteIcon =$('<i>').attr({'class':'fa-solid fa-share mr-auto save-to-note','style':'margin-left:0.5rem;'});
        let likeIcon = $('<i>').attr('class', 'fa-regular fa-thumbs-up like-btn');
        let dislikeIcon = $('<i>').attr('class', 'fa-regular fa-thumbs-down dislike-btn');
        let spanLike = $('<span>').attr('class', 'like-count').text(0);
        let spanDislike = $('<span>').attr('class', 'dislike-count').text(0);
        let a = $('<a>').attr({'href': '#', 'class': 'answer-file', 'data-like': '0', 'data-dislike': '0',}).text(res.file_name);
        divGrid.append(notePanelIcon);
        divGrid.append(a);
        divGrid.append(saveToNoteIcon);
        divGrid.append(likeIcon);
        divGrid.append(spanLike);
        divGrid.append(dislikeIcon);
        divGrid.append(spanDislike);
        divRow.append(divGrid);
        $('#displayFileContainer').append(divRow);
    }else{
      alert(res.error);
    }
  }
  });
}

// Define a search module
const searchModule = (function() {
  // Private functions
  function toggleSearchInput(searchInputId) {
      $(`#${searchInputId}`).toggle();
      if ($(`#${searchInputId}`).is(":visible")) {
          $(`#${searchInputId}`).focus(); // Focus on the input field when it becomes visible
      }
  
      $(document).on('click', function(event) {
          if (!$(event.target).closest('.search-container').length && !$(event.target).is('.search-container')) {
              $(`#${searchInputId}`).hide();
          }
      });
  }
  
  function filter(searchInputId, searchArea) {
      let searchText = $(`#${searchInputId}`).val().toLowerCase();
  
      if(searchArea === '#displayFileContainer a'){
      // for ansSearchInput
        $(searchArea).each(function() {
            let text = $(this).text().toLowerCase();
    
            if (text.includes(searchText)) {
                $(this).parent().parent().show();
            } else {
                $(this).parent().parent().hide();
            }
        });
      }else if(searchArea === '#allSubjectContainer h5'){
          // for subjectSearchInput
          $(searchArea).each(function() {
              let text = $(this).text();
              if (text.includes(searchText)) {
                  $(this).closest(".subject-container").show();
              } else {
                  $(this).closest(".subject-container").hide();
              }
          });
      }else{
          // for each subject searchInput in show-more modal 
          $(searchArea).each(function() {
              let text = $(this).text();
      
              if (text.includes(searchText)) {
                  $(this).show();
              } else {
                  $(this).hide();
              }
      });
  }
  }

  // Public function
  function init(searchIconId, searchInputId, searchArea) {
      $(`#${searchIconId}`).click(function(event) {
          event.preventDefault();
          toggleSearchInput(searchInputId);
      });
      $(`#${searchInputId}`).on('input', function() {
          filter(searchInputId, searchArea);
      });
  }

  // Expose public functions
  return {
      init: init
  };
})();

function likeDislike(){
  $('#displayFileContainer').on('click', '.like-btn', function() {
    let $this = $(this);
    const file = $this.parent().find('.answer-file');
    let fileName = file.text();
    let likeCount = parseInt(file.attr('data-like'));
    let dislikeCount = parseInt(file.attr('data-dislike'));

    if ($this.hasClass('fa-regular')) {
        // Like the file
        file.attr('data-like', ++likeCount);
        $this.removeClass('fa-regular').addClass('fa-solid');
        $this.next('.like-count').text(likeCount);
        // 執行到這裡, 後台關於這份檔案的讚數要去+1
        $.ajax({
          url: '/like_dislike/',
          type: 'post',
          data: {
            'action': 'like+1',
            'subject': SUBJECT,
            'date': DATE,
            'period': PERIOD,
            'number': NUMBER,
            'fileName': fileName,
          },
          dataType: 'JSON',
          success: function(res){
            if(res.status){
              // 接著判斷, 如果原本是按倒讚的情形
              if ($this.siblings('.dislike-btn').hasClass('fa-solid')){
                file.attr('data-dislike', --dislikeCount);
                $this.siblings('.dislike-btn').removeClass('fa-solid').addClass('fa-regular');
                $this.siblings('.dislike-btn').next('.dislike-count').text(dislikeCount);
                // 執行到這裡, 後台關於這份檔案的倒讚數要-1
                $.ajax({
                  url: '/like_dislike/',
                  type: 'post',
                  data: {
                    'action': 'dislike-1',
                    'subject': SUBJECT,
                    'date': DATE,
                    'period': PERIOD,
                    'number': NUMBER,
                    'fileName': fileName,
                  },
                  dataType: 'JSON',
                  success: function(res){
                    if(res.status){
                      console.log(res.message)
                    }else{
                      console.log(res.error)
                    }
              }
            }); // inner ajax end
            }
          }else{
              console.log(res.error) 
            }
          }
        }); // outer ajax end
        
    } else {
        // Cancel like
        file.attr('data-like', --likeCount);
        $this.removeClass('fa-solid').addClass('fa-regular');
        $this.next('.like-count').text(likeCount);
        // 執行到這裡, 後台關於這份檔案的讚數要去-1
        $.ajax({
          url: '/like_dislike/',
          type: 'post',
          data: {
            'action': 'like-1',
            'subject': SUBJECT,
            'date': DATE,
            'period': PERIOD,
            'number': NUMBER,
            'fileName': fileName,
          },
          dataType: 'JSON',
          success: function(res){
            if(res.status){
              console.log(res.message)
            }else{
              console.log(res.error)
            }
      }
    }); // ajax end
    }
    });

  $('#displayFileContainer').on('click', '.dislike-btn', function() {
    let $this = $(this);
    const file = $this.parent().find('.answer-file');
    let fileName = file.text();
    let likeCount = parseInt(file.attr('data-like'));
    let dislikeCount = parseInt(file.attr('data-dislike'));

    if ($this.hasClass('fa-regular')) {
        // Dislike the file
        file.attr('data-dislike', ++dislikeCount);
        $this.removeClass('fa-regular').addClass('fa-solid');
        $this.next('.dislike-count').text(dislikeCount);
        // 執行到這裡, 後台關於這份檔案的倒讚數要+1
        $.ajax({
          url: '/like_dislike/',
          type: 'post',
          data: {
            'action': 'dislike+1',
            'subject': SUBJECT,
            'date': DATE,
            'period': PERIOD,
            'number': NUMBER,
            'fileName': fileName,
          },
          dataType: 'JSON',
          success: function(res){
            if(res.status){
              // 接著判斷, 如果原本是按讚的情形
              if ($this.siblings('.like-btn').hasClass('fa-solid')){
                file.attr('data-like', --likeCount);
                $this.siblings('.like-btn').removeClass('fa-solid').addClass('fa-regular');
                $this.siblings('.like-btn').next('.like-count').text(likeCount);
                // 執行到這裡, 後台關於這份檔案的讚數要-1
                $.ajax({
                  url: '/like_dislike/',
                  type: 'post',
                  data: {
                    'action': 'like-1',
                    'subject': SUBJECT,
                    'date': DATE,
                    'period': PERIOD,
                    'number': NUMBER,
                    'fileName': fileName,
                  },
                  dataType: 'JSON',
                  success: function(res){
                    if(res.status){
                      console.log(res.message)
                    }else{
                      console.log(res.error)
                    }
              }
            }); // inner ajax end
            }
          }else{
              console.log(res.error) 
            }
          }
        }); // outer ajax end
        
    } else {
        // Cancel dislike
        file.attr('data-dislike', --dislikeCount);
        $this.removeClass('fa-solid').addClass('fa-regular');
        $this.next('.dislike-count').text(dislikeCount);
        // 執行到這裡, 後台關於這份檔案的倒讚數要-1
        $.ajax({
          url: '/like_dislike/',
          type: 'post',
          data: {
            'action': 'dislike-1',
            'subject': SUBJECT,
            'date': DATE,
            'period': PERIOD,
            'number': NUMBER,
            'fileName': fileName,
          },
          dataType: 'JSON',
          success: function(res){
            if(res.status){
              console.log(res.message)
            }else{
              console.log(res.error)
            }
      }
    }); // ajax end
    }
  });
}

function likeDislikeCount(){
  $('.row').each(function () {
    var $row = $(this);
    var $answerFile = $row.find('.answer-file');
    var $likeCount = $row.find('.like-count');
    var $dislikeCount = $row.find('.dislike-count');

    $likeCount.text($answerFile.data('like'));
    $dislikeCount.text($answerFile.data('dislike'));
  });
}

function sortDate(){
  const fileItems = $('.answer-file');

  // Convert jQuery object to Array for easier sorting
  const fileArray = $.makeArray(fileItems);

  // Sort the array based on the number in the text of the <a> tag
  fileArray.sort((a, b) => {
    const numA = parseInt($(a).text().split('-')[1].replace('.txt', '')); // .txt要改成筆記檔的副檔名
    const numB = parseInt($(b).text().split('-')[1].replace('.txt', '')); // .txt要改成筆記檔的副檔名
    return numB - numA; // Descending order
  });

  // Remove existing items
  $('#displayFileContainer').empty();

  // Re-append sorted items
  fileArray.forEach((file) => {
    $('#displayFileContainer').append($(file).parent().parent());
  });
}

function sortLike(){
  const fileItems = $('.answer-file');

  // Convert jQuery object to Array for easier sorting
  const fileArray = $.makeArray(fileItems);

  // Sort the array based on the number like-dislike
  fileArray.sort(function(a, b) {
    const aLike = parseInt($(a).data('like'));
    const aDislike = parseInt($(a).data('dislike'));
    const aValue = aLike - aDislike;

    const bLike = parseInt($(b).data('like'));
    const bDislike = parseInt($(b).data('dislike'));
    const bValue = bLike - bDislike;

    return bValue - aValue; // Sort in descending order
  });

  // Remove existing items
  $('#displayFileContainer').empty();

  // Re-append sorted items
  fileArray.forEach((file) => {
    $('#displayFileContainer').append($(file).parent().parent());
  });
}

function sort(){
  // Toggle dropdown menu when sort icon is clicked
  $('#sortIcon').click(function() {
    $('#sortDropdown').toggle();
  });

  // Close the dropdown menu if the user clicks outside of it
  $(document).click(function(event) {
    if (!$(event.target).closest('#sortContainer').length) {
        $('#sortDropdown').hide();
    }
  });

  // Handle sorting logic when the user selects an option
  $('#sortDate').click(function() {
    sortDate();
    $('#sortDropdown').hide();
  });

  $('#sortLike').click(function() {
    sortLike();
    $('#sortDropdown').hide();
  });
}
</script>

{% endblock js %}