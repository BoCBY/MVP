{% extends "navbar.html" %}
{% load static %}

{% block exercise_active %}
active
{% endblock exercise_active %}

{% block exercise_active_span %}
<span class="sr-only">(current)</span>
{% endblock exercise_active_span %}
<!-- 上面這些完善導航條的外觀顯示 -->

{% block css %}

<link rel="stylesheet" href="{% static 'css/exercise_style1.css' %}">

{% endblock css %}



{% block content %}

<div class='container'>
  <div style='margin-top:0.5rem;'>
    <div id="allSubjectContainer"> 
      <!-- exercise各科目的資料夾名稱要與這邊各button的subject屬性一樣 -->
      <!-- 一個大主科就給他一個div去存放 -->
      <!-- 大主科裡面的每一個科目就給他一顆button -->
      <div id="mathContainer">
        <button id="calculusBtn" subject='calculus' type="button" class="btn btn-sm btn-outline-secondary subjectBtn" style='padding: 0.1rem 0.2rem;'>微積分</button>
        <button id="linAlgeBtn" subject='linear_algebra' type="button" class="btn btn-sm btn-outline-secondary subjectBtn" style='padding: 0.1rem 0.2rem;'>線性代數</button>    
      </div>
      <div id="physicsContainer">
        <button id="GenPhyBtn" subject='general_physics' type="button" class="btn btn-sm btn-outline-secondary subjectBtn" style='padding: 0.1rem 0.2rem;'>普通物理</button>
      </div>
    </div>
  </div>
  
  <!-- 各科目的modal -->
  <div class="modal fade" id="exerciseModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title" id="exerciseModalLabel"><strong id='exerciseModalTitle'></strong></h6>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class='container-fluid'>
            <div class='d-flex'>
              <div class='ml-auto'>
                <button id="oneBtn" type="button" class="btn btn-sm btn-warning">試題</button>
              </div>
            </div>
            <div id='questions-container'>
              <div period='present'>
                <h6><strong>當期試題</strong></h6>
              </div>
              <div period='past'>
                <h6 style='margin-top:0.3rem;'><strong>歷期試題</strong></h6> 
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 答案區的modal -->
<div class="modal fade" id="answerModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title" id="answerModalLabel">Modal title</h6>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div id= 'ansTopContainer' style='margin-bottom:0.2rem;'>
          <a href='#' id='answer-previous' class='previous'><i class="fa-solid fa-arrow-left"></i></a>
        </div>
        <h6><strong>題號</strong></h6>
        <table id='questionNumTable'>
          <tr>
              <td><a href='#' class='question-number'>1</a></td>
              <td><a href='#' class='question-number'>2</a></td>
              <td><a href='#' class='question-number'>3</a></td>
              <td><a href='#' class='question-number'>4</a></td>
          </tr>
          <tr>
              <td><a href='#' class='question-number'>5</a></td>
              <td><a href='#' class='question-number'>6</a></td>
              <td><a href='#' class='question-number'>7</a></td>
              <td><a href='#' class='question-number'>8</a></td>
          </tr>
          <tr>
              <td><a href='#' class='question-number'>9</a></td>
              <td><a href='#' class='question-number'>10</a></td>
              <td><a href='#' class='question-number'>11</a></td>
              <td><a href='#' class='question-number'>12</a></td>
          </tr>
      </table>
      </div>
    </div>
  </div>
</div>

<!-- 個別題號的modal -->
<div class="modal fade" id="questionNumModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title" id="ansQuestionNumModalLabel">Modal title</h6>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div id= 'queNumTopContainer' class='container'>
          <div class='d-flex align-items-center'>
            <div id='prevPageContainer' class='mr-auto'>
              <a href='#' id='question-number-previous' class='previous'><i class="fa-solid fa-arrow-left"></i></a>
            </div>
            <div id='searchContainer' class='search-container'>
              <a href='#'><i id='searchIcon' class="fa-solid fa-magnifying-glass"></i></a>
              <input id='searchInput' type='text' placeholder='搜尋' style='display:none;'>
            </div>
            <div id='uploadContainer' style='margin-top:12px;'>
              <label for="fileInput" id="uploadIcon">
                <a href='#'><i class="fa-solid fa-file-arrow-up upload" style="color:#888;"></i></a>
              </label>
              <input type="file" id="fileInput" accept=".txt" style="display: none"> <!-- 測試時只先接受.txt檔, 正式的話就只接受筆記板的那個檔 -->
            </div>
            <div id='sortContainer'>
              <a href='#'><i id='sortIcon' class="fa-solid fa-sort sort" style="color:#888;"></i></a>
              <div id='sortDropdown' class='dropdown-content'>
                  <a href='#' id='sortLike'>評  價</a>
                  <a href='#' id='sortDate'>上傳時間</a>
              </div>
            </div>

          </div>
        </div>
        <div id='displayFileContainer' class='container' style='margin-top:0.3rem;'>
          
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock content %}

{% block js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.min.js"></script>

<script>
  var SUBJECT = undefined;
  var DATE = undefined; // 跟著modal title日期的全域變數, regularQuestion函數的date局域變數與此無關
  var NUMBER = undefined;
  var PERIOD = undefined; // regularQuestion函數的period局域變數與此無關
  
  $(function(){
    subjectBtn();
    oneBtn();
    regularQuestion();
    regularAnswer();
    answerArea();
    ansQuestionNum();
    prevPage();
    upLoad();
    search();
    likeDislike();
    sort();
  })

function subjectBtn(){ 
    $('.subjectBtn').click(function(){
      SUBJECT = $(this).attr('subject');
      let title = $(this).text();
      $.ajax({
        url: '/exercise/',
        type: 'post',
        data: {
          'purpose': 'makeTags',
          'subject': SUBJECT
        },
        dataType: 'JSON',
        success : function(res){
          if (res.status){
            // 先刪除已存的, 不然重複開啟按鈕會不斷生成標籤
            $('div[period="present"] .row').remove();
            $('div[period="past"] .row').remove();

            // 創建當期試題(present)的標籤
            let divRow = $('<div>').attr('class', 'row');
            let divQueCol = $('<div>').attr('class', 'col-sm-5');
            let divAnsCol = $('<div>').attr('class', 'col-sm-5');
            let pdfIcon = $('<i>').attr('class', 'fa-regular fa-file-pdf');
            let folderIcon = $('<i>').attr('class', 'fa-regular fa-folder');
            let aQuestion = $('<a>').attr({'href':'#', 'class':'regular-question', 'date': res.present}).text(res.present+'.pdf');
            let aAnswer = $('<a>').attr({'href':'#', 'class':'regular-answer', 'date': res.present}).text('答案區');
            divQueCol.append(pdfIcon);
            divQueCol.append(aQuestion);
            divAnsCol.append(folderIcon);
            divAnsCol.append(aAnswer);
            divRow.append(divQueCol);
            divRow.append(divAnsCol);
            $('div[period="present"] h6').after(divRow);

            // 創建歷期試題(past)的標籤
            $.each(res.past, function(index, date){
              let divRow = $('<div>').attr('class', 'row');
                let divQueCol = $('<div>').attr('class', 'col-sm-5');
                let divAnsCol = $('<div>').attr('class', 'col-sm-5');
                let pdfIcon = $('<i>').attr('class', 'fa-regular fa-file-pdf');
                let folderIcon = $('<i>').attr('class', 'fa-regular fa-folder');
                let aQuestion = $('<a>').attr({'href':'#', 'class':'regular-question', 'date': date}).text(date+'.pdf');
                let aAnswer = $('<a>').attr({'href':'#', 'class':'regular-answer', 'date': date}).text('答案區');
                divQueCol.append(pdfIcon);
                divQueCol.append(aQuestion);
                divAnsCol.append(folderIcon);
                divAnsCol.append(aAnswer);
                divRow.append(divQueCol);
                divRow.append(divAnsCol);
                $('div[period="past"] h6').after(divRow);
            });
            
            $('#exerciseModalTitle').text(title);
            $('#exerciseModal').modal('show');
          }else{
            alert(res.error);
          }
        }
      });
    });
}

function oneBtn(){
    $('#oneBtn').click(function(){
      $.ajax({
        url:'/exercise/',
        type:'post',
        data:{ 
          'purpose': 'oneBtn',
          'SUBJECT': SUBJECT,
        },
        success: function(res){
          if(res.status){
            window.location.href = '/download_pdf/?path=' + encodeURIComponent(res.pdf_path);
          }else {
            alert(res.error)
          }
        }
      });
    });
}

function regularQuestion(){
    $('#questions-container').on('click', '.regular-question', function(){
      let date = $(this).attr('date');
      let fileName = $(this).text();
      let period = $(this).closest('[period]').attr('period');
      // console.log(period)

    $.ajax({
      url:'/exercise/',
      type:'post',
      data:{
        'purpose': 'regularQuestion',
        'subject': SUBJECT,
        'date': date,
        'fileName': fileName,
        'period': period,
      },
      success: function(res){
        if (res.status){
          window.location.href = '/download_pdf/?path=' + encodeURIComponent(res.file_path);
        }else{
          alert(res.error)
        }
      }
    })
  })
}

function regularAnswer(){
  $('#displayFileContainer').on('click', '.answer-file', function(){
    let fileName = $(this).text();

    $.ajax({
      url:'/exercise/',
      type:'post',
      data:{
        'purpose': 'regularAnswer',
        'subject': SUBJECT,
        'date': DATE,
        'number': NUMBER,
        'period': PERIOD,
        'fileName': fileName,
      },
      success: function(res){
        if (res.status){
          console.log('JJJJ')
          window.location.href = '/download_answer_panel/?path=' + encodeURIComponent(res.file_path);
        }else{
          alert(res.error)
        }
      }
    });
  });
}
        
function answerArea(){
  $('#questions-container').on('click', '.regular-answer', function(){
    DATE = $(this).attr('date');
    PERIOD = $(this).closest('[period]').attr('period');
    let prevModalTitle = $('#exerciseModalTitle').text()
    $('#answerModalLabel').text(prevModalTitle +' - '+ DATE);
    $('#answerModal').modal('show');
    $('#exerciseModal').modal('hide');
  })
}

function ansQuestionNum(){
  $('#questionNumTable').on('click', '.question-number', function(){
    NUMBER = $(this).text()
    let prevModalTitle = $('#answerModalLabel').text()
    $('#ansQuestionNumModalLabel').text(prevModalTitle + ' - ' + NUMBER)
    $('#answerModal').modal('hide');

    $.ajax({
      url:'/exercise/',
      type:'post',
      data:{
        'purpose':'openQuestionNumModal',
        'number': NUMBER,
        'date': DATE,
        'period': PERIOD,
        'subject': SUBJECT,
      },
      dataType:'JSON',
      success: function(res){
        if(res.status){
          /* 創建該題號資料夾裡的DOM標籤 */

          // 先把原本已有的刪除
          $('#displayFileContainer').empty();

          // 開始建DOM標籤
          $.each(res.file_dict, function(fileName, likeDislikeData){
            let divRow = $('<div>').attr('class', 'row');
            let divGrid = $('<div>').attr('class', 'col-sm-12 d-flex align-items-center');
            let notePanelIcon = $('<i>').attr('class', 'fa-solid fa-pen-to-square');
            let likeIcon = $('<i>').attr('class', 'fa-regular fa-thumbs-up like-btn');
            let dislikeIcon = $('<i>').attr('class', 'fa-regular fa-thumbs-down dislike-btn');
            // a與span標籤中喜歡數與不喜歡數是儲存在資料本身的, 要到後台獲取然後填上去
            let spanLike = $('<span>').attr('class', 'like-count').text(likeDislikeData.like); // 對應a的data-like
            let spanDislike = $('<span>').attr('class', 'dislike-count').text(likeDislikeData.dislike); // 對應a的data-dislike
            let a = $('<a>').attr({'href': '#', 'class': 'answer-file mr-auto', 'data-like': likeDislikeData.like, 'data-dislike': likeDislikeData.dislike,}).text(fileName);
            divGrid.append(notePanelIcon);
            divGrid.append(a);
            divGrid.append(likeIcon);
            divGrid.append(spanLike);
            divGrid.append(dislikeIcon);
            divGrid.append(spanDislike);
            divRow.append(divGrid);
            $('#displayFileContainer').append(divRow);
          })
          likeDislikeCount();
          $('#questionNumModal').modal('show');
        }else{
          alert(res.error)
        }
      }
    })
  })
}

function prevPage(){
  $('#queNumTopContainer').on('click', '#question-number-previous', function(){
    $('#questionNumModal').modal('hide');
    $('#answerModal').modal('show');
  });

  $('#ansTopContainer').on('click', '#answer-previous', function(){
    $('#answerModal').modal('hide');
    $('#exerciseModal').modal('show');
  });
}

function upLoad(){
  // 點擊圖標就能上傳檔案的功能
  $('#uploadIcon').on('click', function() {
    $('#fileInput').click();
  });
  
  $('#fileInput').on('change', function() {
    const file = this.files[0];
    if (file.type === 'text/plain') {
      uploadFile(file);
    } else {
      alert('Please select a .txt file');
    }
  });
}

function uploadFile(file) {
  const formData = new FormData(); // a built-in class in js which is key-value pair inside for coveniently using when uploading file
  formData.append('file', file);
  formData.append('subject', SUBJECT);
  formData.append('number', NUMBER);
  formData.append('date', DATE);
  formData.append('period', PERIOD);

  $.ajax({
    url: '/upload_file/', 
    type: 'POST',
    data: formData,
    processData: false,
    contentType: false,
    success: function(res) {
      if(res.status){
        alert(res.message);
        let divRow = $('<div>').attr('class', 'row');
        let divGrid = $('<div>').attr('class', 'col-sm-12 d-flex align-items-center');
        let notePanelIcon = $('<i>').attr('class', 'fa-solid fa-pen-to-square');
        let likeIcon = $('<i>').attr('class', 'fa-regular fa-thumbs-up like-btn');
        let dislikeIcon = $('<i>').attr('class', 'fa-regular fa-thumbs-down dislike-btn');
        let spanLike = $('<span>').attr('class', 'like-count').text(0);
        let spanDislike = $('<span>').attr('class', 'dislike-count').text(0);
        let a = $('<a>').attr({'href': '#', 'class': 'answer-file mr-auto', 'data-like': '0', 'data-dislike': '0',}).text(res.file_name);
        divGrid.append(notePanelIcon);
        divGrid.append(a);
        divGrid.append(likeIcon);
        divGrid.append(spanLike);
        divGrid.append(dislikeIcon);
        divGrid.append(spanDislike);
        divRow.append(divGrid);
        $('#displayFileContainer').append(divRow);
    }else{
      alert(res.error);
    }
  }
  });
}

function toggleSearchInput() {
  $('#searchInput').toggle();
  if ($('#searchInput').is(":visible")) {
      $('#searchInput').focus(); // Focus on the input field when it becomes visible
  }

  $(document).on('click', function(event) {
    if (!$(event.target).closest('#searchContainer').length && !$(event.target).is('#searchContainer')) {
        $('#searchInput').hide();
    }
  });
}

function filter() {
  // Get the search input value
  let searchText = $('#searchInput').val().toLowerCase();

  // Loop through each file link
  $('#displayFileContainer a').each(function() {
      // Get the text content of the file link and convert it to lowercase
      let text = $(this).text().toLowerCase();

      // Show or hide the file link based on whether the search text is found in the link text
      if (text.includes(searchText)) {
          $(this).parent().parent().show();
      } else {
          $(this).parent().parent().hide();
      }
  });
}

function search(){
  $('#searchIcon').click(toggleSearchInput)
  $('#searchInput').on('input', filter);
}

function likeDislike(){
  $('#displayFileContainer').on('click', '.like-btn', function() {
    let $this = $(this);
    const file = $this.parent().find('.answer-file');
    let fileName = file.text();
    let likeCount = parseInt(file.attr('data-like'));
    let dislikeCount = parseInt(file.attr('data-dislike'));

    if ($this.hasClass('fa-regular')) {
        // Like the file
        file.attr('data-like', ++likeCount);
        $this.removeClass('fa-regular').addClass('fa-solid');
        $this.next('.like-count').text(likeCount);
        // 執行到這裡, 後台關於這份檔案的讚數要去+1
        $.ajax({
          url: '/like_dislike/',
          type: 'post',
          data: {
            'action': 'like+1',
            'subject': SUBJECT,
            'date': DATE,
            'period': PERIOD,
            'number': NUMBER,
            'fileName': fileName,
          },
          dataType: 'JSON',
          success: function(res){
            if(res.status){
              // 接著判斷, 如果原本是按倒讚的情形
              if ($this.siblings('.dislike-btn').hasClass('fa-solid')){
                file.attr('data-dislike', --dislikeCount);
                $this.siblings('.dislike-btn').removeClass('fa-solid').addClass('fa-regular');
                $this.siblings('.dislike-btn').next('.dislike-count').text(dislikeCount);
                // 執行到這裡, 後台關於這份檔案的倒讚數要-1
                $.ajax({
                  url: '/like_dislike/',
                  type: 'post',
                  data: {
                    'action': 'dislike-1',
                    'subject': SUBJECT,
                    'date': DATE,
                    'period': PERIOD,
                    'number': NUMBER,
                    'fileName': fileName,
                  },
                  dataType: 'JSON',
                  success: function(res){
                    if(res.status){
                      console.log(res.message)
                    }else{
                      console.log(res.error)
                    }
              }
            }); // inner ajax end
            }
          }else{
              console.log(res.error) 
            }
          }
        }); // outer ajax end
        
    } else {
        // Cancel like
        file.attr('data-like', --likeCount);
        $this.removeClass('fa-solid').addClass('fa-regular');
        $this.next('.like-count').text(likeCount);
        // 執行到這裡, 後台關於這份檔案的讚數要去-1
        $.ajax({
          url: '/like_dislike/',
          type: 'post',
          data: {
            'action': 'like-1',
            'subject': SUBJECT,
            'date': DATE,
            'period': PERIOD,
            'number': NUMBER,
            'fileName': fileName,
          },
          dataType: 'JSON',
          success: function(res){
            if(res.status){
              console.log(res.message)
            }else{
              console.log(res.error)
            }
      }
    }); // ajax end
    }
    });

  $('#displayFileContainer').on('click', '.dislike-btn', function() {
    let $this = $(this);
    const file = $this.parent().find('.answer-file');
    let fileName = file.text();
    let likeCount = parseInt(file.attr('data-like'));
    let dislikeCount = parseInt(file.attr('data-dislike'));

    if ($this.hasClass('fa-regular')) {
        // Dislike the file
        file.attr('data-dislike', ++dislikeCount);
        $this.removeClass('fa-regular').addClass('fa-solid');
        $this.next('.dislike-count').text(dislikeCount);
        // 執行到這裡, 後台關於這份檔案的倒讚數要+1
        $.ajax({
          url: '/like_dislike/',
          type: 'post',
          data: {
            'action': 'dislike+1',
            'subject': SUBJECT,
            'date': DATE,
            'period': PERIOD,
            'number': NUMBER,
            'fileName': fileName,
          },
          dataType: 'JSON',
          success: function(res){
            if(res.status){
              // 接著判斷, 如果原本是按讚的情形
              if ($this.siblings('.like-btn').hasClass('fa-solid')){
                file.attr('data-like', --likeCount);
                $this.siblings('.like-btn').removeClass('fa-solid').addClass('fa-regular');
                $this.siblings('.like-btn').next('.like-count').text(likeCount);
                // 執行到這裡, 後台關於這份檔案的讚數要-1
                $.ajax({
                  url: '/like_dislike/',
                  type: 'post',
                  data: {
                    'action': 'like-1',
                    'subject': SUBJECT,
                    'date': DATE,
                    'period': PERIOD,
                    'number': NUMBER,
                    'fileName': fileName,
                  },
                  dataType: 'JSON',
                  success: function(res){
                    if(res.status){
                      console.log(res.message)
                    }else{
                      console.log(res.error)
                    }
              }
            }); // inner ajax end
            }
          }else{
              console.log(res.error) 
            }
          }
        }); // outer ajax end
        
    } else {
        // Cancel dislike
        file.attr('data-dislike', --dislikeCount);
        $this.removeClass('fa-solid').addClass('fa-regular');
        $this.next('.dislike-count').text(dislikeCount);
        // 執行到這裡, 後台關於這份檔案的倒讚數要-1
        $.ajax({
          url: '/like_dislike/',
          type: 'post',
          data: {
            'action': 'dislike-1',
            'subject': SUBJECT,
            'date': DATE,
            'period': PERIOD,
            'number': NUMBER,
            'fileName': fileName,
          },
          dataType: 'JSON',
          success: function(res){
            if(res.status){
              console.log(res.message)
            }else{
              console.log(res.error)
            }
      }
    }); // ajax end
    }
  });
}

function likeDislikeCount(){
  $('.row').each(function () {
    var $row = $(this);
    var $answerFile = $row.find('.answer-file');
    var $likeCount = $row.find('.like-count');
    var $dislikeCount = $row.find('.dislike-count');

    $likeCount.text($answerFile.data('like'));
    $dislikeCount.text($answerFile.data('dislike'));
  });
}

function sortDate(){
  const fileItems = $('.answer-file');

  // Convert jQuery object to Array for easier sorting
  const fileArray = $.makeArray(fileItems);

  // Sort the array based on the number in the text of the <a> tag
  fileArray.sort((a, b) => {
    const numA = parseInt($(a).text().split('-')[1].replace('.txt', '')); // .txt要改成筆記檔的副檔名
    const numB = parseInt($(b).text().split('-')[1].replace('.txt', '')); // .txt要改成筆記檔的副檔名
    return numB - numA; // Descending order
  });

  // Remove existing items
  $('#displayFileContainer').empty();

  // Re-append sorted items
  fileArray.forEach((file) => {
    $('#displayFileContainer').append($(file).parent().parent());
  });
}

function sortLike(){
  const fileItems = $('.answer-file');

  // Convert jQuery object to Array for easier sorting
  const fileArray = $.makeArray(fileItems);

  // Sort the array based on the number like-dislike
  fileArray.sort(function(a, b) {
    const aLike = parseInt($(a).data('like'));
    const aDislike = parseInt($(a).data('dislike'));
    const aValue = aLike - aDislike;

    const bLike = parseInt($(b).data('like'));
    const bDislike = parseInt($(b).data('dislike'));
    const bValue = bLike - bDislike;

    return bValue - aValue; // Sort in descending order
  });

  // Remove existing items
  $('#displayFileContainer').empty();

  // Re-append sorted items
  fileArray.forEach((file) => {
    $('#displayFileContainer').append($(file).parent().parent());
  });
}

function sort(){
  // Toggle dropdown menu when sort icon is clicked
  $('#sortIcon').click(function() {
    $('#sortDropdown').toggle();
  });

  // Close the dropdown menu if the user clicks outside of it
  $(document).click(function(event) {
    if (!$(event.target).closest('#sortContainer').length) {
        $('#sortDropdown').hide();
    }
  });

  // Handle sorting logic when the user selects an option
  $('#sortDate').click(function() {
    sortDate();
    $('#sortDropdown').hide();
  });

  $('#sortLike').click(function() {
    sortLike();
    $('#sortDropdown').hide();
  });

}
</script>

{% endblock js %}